import { NextApiRequest, NextApiResponse } from 'next';\nimport { getSession } from 'next-auth/react';\nimport prisma from '../../../lib/prisma';\n\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\n  if (req.method !== 'POST') return res.status(405).end();\n  const session = await getSession({ req });\n  if (!session?.user?.email) return res.status(401).json({ error: 'Not authenticated' });\n\n  const user = await prisma.user.findUnique({ where: { email: session.user.email } });\n  if (!user) return res.status(404).json({ error: 'User not found' });\n\n  const applicationCount = await prisma.application.count({ where: { candidateId: user.id } });\n  if (applicationCount < 2) {\n    return res.status(403).json({ error: 'Apply to at least two jobs to generate a resume.' });\n  }\n\n  // create a Resume placeholder and a queued ResumeJob\n  const resume = await prisma.resume.create({ data: { userId: user.id, url: '', template: 'default', status: 'PENDING' } });\n  const job = await prisma.resumeJob.create({ data: { userId: user.id, template: 'default', resumeId: resume.id } });\n\n  res.status(202).json({ jobId: job.id, resumeId: resume.id });\n}